# GPU

gpuå±‚æ¬¡ç»“æž„å›¾å¦‚ä¸‹

![gpu_whole](/assets/img/blog/img_arch/whole.png)

## thread, block, grid

1.å…³ç³»

ä¸€ä¸ªkernelæœ‰ä¸€ä¸ªgridï¼Œä¸€ä¸ªgridæœ‰å¤šä¸ªblockï¼Œä¸€ä¸ªblockæœ‰å¤šä¸ªthreadï¼ˆæŒ‰warpï¼‰åˆ†ç»„

æ¯ä¸ªGridå¯ä»¥æœ€å¤šåˆ›å»º65535ä¸ªblockï¼Œæ¯ä¸ªBlockæœ€å¤š512ä¸ªthread

> workgroupå…¶å®žæ˜¯onenclçš„æœ¯è¯­ï¼Œå¯¹åº”cudaå°±æ˜¯é€»è¾‘ä¸Šçš„blockã€‚

2.è®¿å­˜å±‚æ¬¡

è®¿é—®å±‚æ¬¡ä¸Šï¼Œthreadæ“ä½œregister(local memory)ï¼Œblockæ“ä½œshare memoryï¼Œgridæ“ä½œglobal ramï¼Œæ‰€ä»¥ thread ä¸€æ¬¡åªèƒ½å–ä¸€ä¸ªå¯„å­˜å™¨çš„å€¼ã€‚

> è¶Šé«˜è®¿å­˜å±‚æ¬¡çš„è®¿é—®latencyè¶Šå°

æ¯ä¸ª bank ä¸€æ¬¡åªèƒ½å¤„ç†ä¸€ä¸ªè®¿é—®ï¼Œå½“å¤šæ¡ thread è®¿é—®çš„æ•°æ®å¤„äºŽåŒä¸€ä¸ª bankï¼Œåˆ™ä¼šå‘ç”Ÿ bank conflictã€‚

è®¿å­˜åˆå¹¶æ˜¯å°†å¤šä¸ª å†…å­˜è®¿é—®è¯·æ±‚ åˆå¹¶æˆè¾ƒå°‘çš„ å†…å­˜è®¿é—®è¯·æ±‚ ï¼Œä½†æ¯ä¸ªçº¿ç¨‹è¿˜æ˜¯åªè®¿é—®ä¸€ä¸ªå…ƒç´ æ•°æ®ã€‚

> ä¸€ä¸ª warp ä¸­çš„ thread åœ¨åŒä¸€æ—¶é—´æ‰§è¡Œç›¸åŒçš„æŒ‡ä»¤ã€‚æ‰€ä»¥è®¿å­˜è¿žç»­åŽï¼Œå¯ä»¥åŠ å¤§å•æ—¶é—´å†…è®¿é—®çš„æ•°é‡

ä¸€ä¸ªblockå†…çš„æ‰€æœ‰threadé€šè¿‡share memoryï¼ˆè¿™ä¸ªshare mem å°±æ˜¯è´Ÿè´£è¯¥blockçš„L1 Cacheï¼‰æ¥äº¤æ¢æ•°æ®ã€‚ä¸åŒblockä¹‹é—´çš„threadæ˜¯æ— æ³•é€šä¿¡çš„

> Hopper æž¶æž„å¢žåŠ äº† SM-to-SM çš„çº¿è·¯ï¼Œæ‰€ä»¥å¤šä¸ª block ç†è®ºä¸Šå¯ä»¥å…±åŒä½¿ç”¨è´Ÿè´£å®ƒä»¬çš„ SM çš„ shared memã€‚

3.CTA, CGA

cooperative thread arrayï¼šå°±æ˜¯ thread block

cooperative grid arrayï¼šå®ƒæ˜¯ä¸€ç»„CTAçš„é›†åˆï¼Œå¯ä»¥åœ¨GPUä¸ŠååŒå·¥ä½œã€‚CGAå¯ä»¥ç”¨äºŽæ›´å¤§è§„æ¨¡çš„å¹¶è¡Œè®¡ç®—ï¼Œå°†ä»»åŠ¡åˆ’åˆ†ä¸ºå¤šä¸ªCTAè¿›è¡Œæ‰§è¡Œï¼Œå¹¶ä¸”CTAä¹‹é—´å¯ä»¥é€šè¿‡å…¨å±€å†…å­˜è¿›è¡Œé€šä¿¡å’ŒåŒæ­¥ã€‚

4.warp

blockä¸­çš„threadåˆä¼šä»¥warpï¼ˆçº¿ç¨‹æŸï¼‰ä¸ºå•ä½ï¼Œå¯¹threadè¿›è¡Œåˆ†ç»„ç»„ç»‡ã€‚

warpå¤§å°å½“å‰ä¸€èˆ¬æ˜¯32ã€‚æ¯”å¦‚è¯´å¦‚æžœæœ‰ä¸€ä¸ªblock é‡Œæœ‰128 ä¸ªthread çš„è¯ï¼Œå°±ä¼šè¢«åˆ†æˆå››ç»„warpï¼Œç¬¬0-31 ä¸ªthread ä¼šæ˜¯warp 1ã€32-63 æ˜¯warp 2ã€64-95æ˜¯warp 3ã€96-127 æ˜¯warp 4ã€‚è€Œå¦‚æžœblock é‡Œé¢çš„thread æ•°é‡ä¸æ˜¯32 çš„å€æ•°ï¼Œé‚£ä»–ä¼šæŠŠå‰©ä¸‹çš„threadç‹¬ç«‹æˆä¸€ä¸ªwarpã€‚

warp å†…çš„ thread åœ¨åŒä¸€æ—¶é—´æ‰§è¡Œç›¸åŒçš„æŒ‡ä»¤ï¼Œé€»è¾‘ä¸Šå’Œ SIMD ç›¸ä¼¼ã€‚

> SMæ˜¯è´Ÿè´£å®Œæˆ block è®¡ç®—ä»»åŠ¡çš„æ‰§è¡Œå•å…ƒã€‚warp åˆ†ç»„çš„åŠ¨ä½œæ˜¯ç”± SM è‡ªåŠ¨è¿›è¡Œçš„ã€‚

å¯¹äºŽè®¡ç®—å¯†é›†åž‹kernelï¼Œ4-warpé…ç½®é€šå¸¸æ˜¯æœ€å¸¸ç”¨/é¦–é€‰çš„ã€‚8-warpé…ç½®å¯èƒ½ä¼šåœ¨prologueæˆ–epilogueé˜¶æ®µå¼•å…¥ä¸€äº›å»¶è¿Ÿã€‚å¯¹äºŽéžå¸¸å°çš„GEMMé—®é¢˜ï¼Œå¯ä»¥å°è¯•2-warpæˆ–1-warpé…ç½®ã€‚

ä¸€ä¸ªSM å¯ä»¥åŒæ—¶å¤„ç†å¤šä¸ªçº¿ç¨‹å—blockï¼Œå½“å…¶ä¸­æœ‰block çš„æ‰€æœ‰thread éƒ½å¤„ç†å®ŒåŽï¼Œä»–å°±ä¼šå†åŽ»æ‰¾å…¶ä»–è¿˜æ²¡å¤„ç†çš„block æ¥å¤„ç†ã€‚

5.thread block cluster

ä¸€ä¸ªBlockçš„Threadé…è¾ƒå°‘æ—¶->æ‰§è¡Œæ…¢

ä¸€ä¸ªBlockçš„Threadé…è¾ƒå¤šæ—¶->SMåˆ©ç”¨çŽ‡ä½Žï¼Œä¸”blockå¯ä½¿ç”¨çš„smemæœ‰é™ï¼Œå½“è´Ÿè´£çš„ä»»åŠ¡è§„æ¨¡è¾ƒå¤§æ—¶ï¼Œåˆ™éœ€è¦ä½¿ç”¨gdramï¼Œä½¿å¾—IOæˆä¸ºç“¶é¢ˆ

ä»¥blockä¸ºç²’åº¦æ¥å¤„ç†ä»»åŠ¡é˜»ç¢è¿è¡Œæ•ˆçŽ‡ï¼Œéœ€è¦æä¾›æ›´å¤§ç²’åº¦çš„çº¿ç¨‹ç»„

thread block clusteræ˜¯æ›´å¤§ç²’åº¦çš„çº¿ç¨‹ç»„ï¼Œå…¶ä¸­çš„çº¿ç¨‹ç»„å¯ä»¥è®¿é—®åˆ†å¸ƒåœ¨ä¸åŒblockçš„smemï¼Œè¿™äº›smemç§°ä¸º distributed smem

smemå’ŒSMçš„L1Cacheå…±ç”¨ä¸€å—ç‰©ç†ç©ºé—´ï¼Œä½†Cacheæ˜¯ä¸å¯è§çš„ï¼Œè€Œsmemæ˜¯ç¨‹åºå‘˜å¯è§çš„ï¼Œè¿™æ˜¯SMç§æœ‰ï¼ˆL2 Cacheæ˜¯å…±ç”¨çš„ï¼‰ã€‚ä½†è‹¥thread block clusterçš„blockåœ¨å¤šä¸ªSMä¸Šè¿è¡Œï¼Œå°±éœ€è¦ç‰¹æ®Šçš„ç»“æž„å®žçŽ°SMçš„smemå…±äº«ã€‚

## SM

1.æž¶æž„

![sm](/assets/img/blog/img_triton_survey/gpu_arch.png)

- INTU æ•´æ•°è®¡ç®—å•å…ƒ
- FPU å•ç²¾åº¦æµ®ç‚¹è®¡ç®—å•å…ƒ
- DPU åŒç²¾åº¦æµ®ç‚¹è®¡ç®—å•å…ƒ
- SFU ç‰¹æ®Šfunctioå•å…ƒ
- LDST load-storeå•å…ƒ

æ¯ä¸ª SM éƒ½æœ‰ç‹¬ç«‹çš„ smem, constant cache, register memï¼ŒSMä¹‹é—´å…±äº« L2 Cache å’Œ gdramã€‚ SM(æµå¼å¤šå¤„ç†å™¨) ä¸­çš„å¤„ç†å•ä½ç§°ä¸º SP(æµç¤ºå¤„ç†å™¨)ã€‚

è‡ª Volta æž¶æž„åŽï¼ŒSM ä¸­çš„ smem å’Œ L1 Cache å°±åˆå¹¶æˆä¸€å— memory block äº†ã€‚

å¦‚æ­¤ç¨‹åºå‘˜å°±å¯ä»¥è‡ªè¡Œé…ç½® smem çš„å¤§å°ï¼Œåœ¨æ”¾å­˜å¯†é›†ä¸”è¿žç»­çš„åœºæ™¯ä¸‹ï¼ˆä¾‹å¦‚matmulï¼‰ï¼Œsmemå¤§ä¸€äº›æ€§èƒ½æ›´å¥½ã€‚ä½†æ˜¯ smem å’Œ L1 Cacheçš„æ€»å¤§å°æ˜¯ä¸€å®šçš„ã€‚

L1 Cacheä¿ç•™çš„åŽŸå› ï¼šL1åœ¨æŸäº›åœºæ™¯ä¸‹ä¹Ÿæ˜¯å¿…è¦çš„ï¼Œä¾‹å¦‚ä»¥ sparse computing ä¸­ï¼›smemæ˜¯å¾ˆå¿«ä¼šç”¨åˆ°çš„ï¼ŒL1æ˜¯ä»Ždramä¸Šå–æ¥çš„ï¼Œcacheæ˜¯é˜²æ­¢ä½Žé€Ÿè®¿å­˜å¿…è¦çš„ï¼Œsmemèƒ½é˜²æ­¢æ±¡æŸ“cacheã€‚

Hopper æž¶æž„ä¸­å¼•å…¥äº† SM-to-SM çš„é«˜é€Ÿç½‘ç»œï¼Œå®žçŽ°äº† SM ä¹‹é—´çš„ smem äº’ç›¸è®¿é—®ã€‚è¿™ä¸º Thread Block Cluster æä¾›äº†ç¼–ç¨‹æ”¯æŒã€‚

Thread Block Cluster çš„æå‡ºæ˜¯å› ä¸ºä»¥ thread block ä¸ºç²’åº¦æ‰§è¡Œä»»åŠ¡é˜»ç¢è¿è¡Œæ•ˆçŽ‡ã€‚éœ€è¦æä¾›æ›´å¤§ç²’åº¦çš„çº¿ç¨‹ç»„ã€‚æ‰€ä»¥ä¸€ä¸ª thread block cluster ä¸­åŒ…å«å¤šä¸ª thread blockï¼Œå…¶ä¸­æ‰€æœ‰ thread éƒ½å¯ä»¥è®¿é—®è´Ÿè´£è¯¥ thread block cluster è®¡ç®—çš„ SM ç¾¤çš„ smemï¼Œè¿™äº› smem ä¸€èµ·ç§°ä¸º distributed smemã€‚

2.warp scheduler

æ¯ä¸ª warp ä¼šè¢«åˆ†é…åˆ°ä¸€ä¸ª warp scheduler ä¸Šï¼Œwarp scheduler å¯ä»¥åœ¨ä¸åŒçš„ warp ä¹‹é—´åˆ‡æ¢ã€‚å½“æŸä¸ª warp stall æ—¶ï¼Œå¯ä»¥é€šè¿‡åˆ‡æ¢ warp æ¥æŽ©ç›–è®¿å­˜å¼€é”€(åœ¨è®¿å­˜æ—¶æ¢å¦ä¸€ä¸ªwarpä¸Š)ï¼Œæ¥å‡å°‘ stall æ—¶é—´ã€‚

æ¯”å¦‚ Ampere 4 ä¸ª warp schedulerï¼Œæ‰€ä»¥ thread block ä¸€èˆ¬çº¿ç¨‹æ•°ä¸ä¼šå°‘äºŽ 128 ä¸ªï¼Œ256 ä¸ªæ¯”è¾ƒå¸¸ç”¨ï¼Œå› ä¸ºå¯ä»¥åˆ‡æ¢ warp æ¥å‡å°‘ stall çš„æ—¶é—´ã€‚

æ¯ä¸ª warp scheduler ðŸˆ¶ä¸¤ä¸ª instruction dispatchï¼Œæ¯ä¸ª cycle éƒ½å¯ä»¥å‘å½“å‰å¤„äºŽå…¶ä¸Šçš„ warp å‘é€ä¸¤æ¡æŒ‡ä»¤ã€‚

## memory unit

DMA, TMA

- Direct Memory Access ç”¨äºŽæé«˜æ•°æ®ä¼ è¾“
- Tensor Memory Accelerator ä¸“é—¨è®¾è®¡ç”¨æ¥å¼ é‡æ•°æ®çš„ä¼ è¾“

## data access

1.gdram-smem æ•°æ®è®¿é—®çš„æµç¨‹ï¼š

(1)è™šæ‹Ÿåœ°å€è½¬ç‰©ç†åœ°å€

(2)ROBç”³è¯·ç©ºé—´ï¼Œä»¥ä¾¿äºŽ(ä¹±åºæ‰§è¡Œæ—¶)æäº¤æ—¶èŽ·å¾—æ­£ç¡®çš„ç›®çš„åœ°å€

(3)å‘é€æ€»çº¿è¯·æ±‚åˆ°LLC

(4)LLCå‘½ä¸­åˆ™è¿”å›žï¼Œå¤±è´¥åˆ™ä»Žgdramä¸­æ‰¾

2.memory-coalecse

å¦‚æžœä¸€ä¸ª warp éœ€è¦å¤„ç†çš„æ•°æ®è¿žç»­æ—¶ï¼Œå°±å¯ä»¥å°†å¤šä¸ª thread çš„å†…å­˜è®¿é—®è¯·æ±‚åˆå¹¶æˆä¸€ä¸ªæˆ–è€…è¾ƒå°‘ä¸ªå†…å­˜ä¼ è¾“è¯·æ±‚ï¼Œè€Œä¸æ˜¯æ¯ä¸ª thread å•ç‹¬è¿›è¡Œå†…å­˜è®¿é—®ã€‚

pass å‰åŽéƒ½æ˜¯æ¯æ¡ thread å•ç‹¬å‘é€è‡ªå·±çš„å†…å­˜è¯·æ±‚ï¼Œè¿™äº›è¯·æ±‚è¢«åˆå¹¶åŽç”±äºŽ LSU(Load/Store Uint) å‘é€è¯·æ±‚åˆ°ç¡¬ä»¶ã€‚

3.layout swizzling

smem ä¸­æ•°æ®æ˜¯ä»¥ bank çš„å½¢å¼ç»„ç»‡çš„ï¼Œæ¯ä¸ª bank å¯ä»¥å•ç‹¬å¤„ç†ä¸€ä¸ªå†…å­˜è®¿é—®è¯·æ±‚ã€‚å¦‚æžœå¤šä¸ªå†…å­˜è®¿é—®è¯·æ±‚éƒ½æŒ‡å‘åŒä¸€ bankï¼Œåˆ™ä¼šäº§ç”Ÿ bank-conflictã€‚

æ‰€ä»¥éœ€è¦ layout-swizzling å¯¹æ•°æ®è¿›è¡Œé‡æ–°æŽ’åˆ—ï¼Œç¡®ä¿warpåœ¨åŒä¸€æ—¶åˆ»çš„å¤šä¸ªå†…å­˜è®¿é—®è¯·æ±‚å¤„äºŽä¸åŒçš„ bankã€‚

layout-swizzling æ˜¯é€šè¿‡è½¯ä»¶ç®—æ³•æ”¹å˜åœ°å€æ˜ å°„å…³ç³»ï¼Œä½¿å¾—å†…å­˜è®¿å­˜æ¨¡å¼å’Œç‰©ç†å­˜å‚¨å¸ƒå±€æ›´åŒ¹é…ã€‚ logic layout -> swizzle mapping  -> physical layout

## IR

1. PTX å’Œ SSAS

ptx å’Œ sass çš„åŒºåˆ«åœ¨äºŽï¼Œä¸€ä¸ªè¡¨ç¤ºè™šæ‹Ÿï¼Œä¸€ä¸ªè¡¨ç¤ºå®žé™…ã€‚ ptx æŒ‡ä»¤åªå®šä¹‰äº†æŒ‡ä»¤çš„åŠŸèƒ½ï¼Œè€Œ sass æŒ‡ä»¤è¡¨æ˜Žäº†é’ˆå¯¹ä¸åŒä»£æž¶æž„çš„åº•å±‚å®žçŽ°ã€‚

> cubin æ˜¯ç¡¬ä»¶äºŒè¿›åˆ¶æŒ‡ä»¤ã€‚
